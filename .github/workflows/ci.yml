name: Docker Image CI

on:
  push:
    branches: [ master ]
    tags:
      - '*'
  pull_request:
    branches: [ master ]

env:
  IMAGE_NAME: neuraleduseg-service

jobs:

  build:
    name: Build, test and publish Docker image to Docker Hub
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Get the git tag name
      id: get_git_tag
      run: echo ::set-output name=GIT_TAG::${GITHUB_REF#refs/tags/}

    - name: Build Docker image
      run:docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:${{ github.run_number }} -t $IMAGE_NAME:${{ steps.get_git_tag.outputs.GIT_TAG }} .
    - name: Run pytest in Docker
      run: docker run --entrypoint=pytest $IMAGE_NAME

    - name: Login to Docker Hub
      run: docker login -u ${{ secrets.DOCKERHUB_USER }} -p ${{ secrets.DOCKERHUB_PASSWORD }}
    - name: Publish Docker image
      run: docker push $IMAGE_NAME
